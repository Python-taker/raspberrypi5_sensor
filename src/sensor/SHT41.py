#!/usr/bin/env python3
"""
SHT41.py
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- PCA9548A IÂ²C ë©€í‹°í”Œë ‰ì„œ(ì£¼ì†Œ 0x74) ì±„ë„ 1ì— ì—°ê²°ëœ SHT41 ì„¼ì„œì—ì„œ ì˜¨ìŠµë„ ì¸¡ì •
- CRC-8 ê²€ì¦ í¬í•¨, ê³ ì •ë°€ ì¸¡ì • ëª¨ë“œ(0xFD) ì‚¬ìš©

!! ì£¼ì˜ ì‚¬í•­ !!
1) IÂ²C í™œì„±í™” í•„ìš” (raspi-config â†’ Interface Options â†’ I2C â†’ Enable)
2) PCA9548A ì£¼ì†Œì™€ ì±„ë„ ë²ˆí˜¸(TARGET_CHANNEL) í™•ì¸ í•„ìˆ˜
3) CRC ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°ì´í„° ë¬´íš¨ ì²˜ë¦¬

ğŸ“Œ í˜¸ì¶œ ê´€ê³„ ë° ì‚¬ìš©ë²•
- ë‹¨ë… ì‹¤í–‰ ê°€ëŠ¥ (CLI í…ŒìŠ¤íŠ¸ìš©): `python3 SHT41.py`
- ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ import ì‹œ: `select_channel()`, `read_sht41()` ì‚¬ìš© ê°€ëŠ¥
"""

import time
from smbus2 import SMBus, i2c_msg
from typing import Tuple

# â”€â”€â”€ ì£¼ì†Œ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PCA9548A_ADDR  = 0x74       # PCA9548A I2C ì£¼ì†Œ
SHT41_ADDR     = 0x44       # SHT4x ì„¼ì„œ ê³ ì • ì£¼ì†Œ
TARGET_CHANNEL = 1          # SHT41 ì—°ê²° ì±„ë„

# â”€â”€â”€ ë¡œê·¸ ì œì–´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VERBOSE = False  # ë‹¨ë… ì‹¤í–‰ ì‹œ Trueë¡œ ë‘ë©´ ë¡œê·¸ê°€ ë³´ì„

# =====================================================
# 1ï¸âƒ£ PCA9548A ì±„ë„ ì„ íƒ
# =====================================================
def select_channel(bus: SMBus, ch: int) -> None:
    """
    PCA9548Aì—ì„œ íŠ¹ì • ì±„ë„ì„ ì„ íƒ.

    Args:
        bus: IÂ²C ë²„ìŠ¤ ê°ì²´
        ch: í™œì„±í™”í•  ì±„ë„ ë²ˆí˜¸ (0~7)
    """
    bus.write_byte(PCA9548A_ADDR, 1 << ch)
    time.sleep(0.05)

# =====================================================
# 2ï¸âƒ£ CRC í™•ì¸ (SHT4x CRC-8 ì•Œê³ ë¦¬ì¦˜)
# =====================================================
def validate_crc(data_bytes, crc_value) -> bool:
    """
    SHT4x ì„¼ì„œ ë°ì´í„° CRC-8 ê²€ì¦.

    Args:
        data_bytes (list[int]): CRC ê³„ì‚° ëŒ€ìƒ ë°”ì´íŠ¸ ë¦¬ìŠ¤íŠ¸
        crc_value (int): ìˆ˜ì‹ ëœ CRC ê°’
    """
    crc = 0xFF
    for byte in data_bytes:
        crc ^= byte
        for _ in range(8):
            if crc & 0x80:
                crc = (crc << 1) ^ 0x31
            else:
                crc <<= 1
            crc &= 0xFF
    return crc == crc_value

# =====================================================
# 3ï¸âƒ£ SHT41 ì¸¡ì • ë° ë³€í™˜
# =====================================================
def read_sht41(bus: SMBus) -> Tuple[float, float]:
    """
    SHT41 ì„¼ì„œì—ì„œ ì˜¨ë„/ìŠµë„ ë°ì´í„°ë¥¼ ì¸¡ì •.

    Args:
        bus: IÂ²C ë²„ìŠ¤ ê°ì²´

    Returns:
        (ì˜¨ë„[Â°C], ìŠµë„[%RH])

    Raises:
        RuntimeError: ìˆ˜ì‹  ë°ì´í„° ê¸¸ì´ ì˜¤ë¥˜
        ValueError: CRC ê²€ì¦ ì‹¤íŒ¨
        OSError: IÂ²C í†µì‹  ì˜¤ë¥˜
    """
    # ê³ ì •ë°€ ì¸¡ì • ëª…ë ¹ (0xFD)
    bus.write_byte(SHT41_ADDR, 0xFD)
    time.sleep(0.5)  # ë°ì´í„° ì¤€ë¹„ ì‹œê°„

    # ë°ì´í„° ì½ê¸° (6ë°”ì´íŠ¸: T[2]+CRC + RH[2]+CRC)
    read = i2c_msg.read(SHT41_ADDR, 6)
    bus.i2c_rdwr(read)
    data = list(read)

    if len(data) != 6:
        raise RuntimeError("ì„¼ì„œ ë°ì´í„° ê¸¸ì´ ì˜¤ë¥˜")

    # CRC í™•ì¸
    if not validate_crc(data[:2], data[2]) or not validate_crc(data[3:5], data[5]):
        raise ValueError("CRC ì˜¤ë¥˜ ë°œìƒ")

    t_raw = (data[0] << 8) | data[1]
    h_raw = (data[3] << 8) | data[4]

    # ë°ì´í„° ë³€í™˜ ê³µì‹ (Datasheet ê¸°ì¤€)
    temperature = -45 + (175 * (t_raw / 65535.0))
    humidity    = 100 * (h_raw / 65535.0)

    return round(temperature, 1), round(humidity, 1)

# =====================================================
# 4ï¸âƒ£ ë‹¨ë… ì‹¤í–‰ ì§„ì…ì  (import ì‹œì—ëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ)
# =====================================================
if __name__ == '__main__':
    with SMBus(1) as bus:
        if VERBOSE:
            print(f"\nğŸ”€ ì±„ë„ {TARGET_CHANNEL} ì„ íƒ")
        select_channel(bus, TARGET_CHANNEL)

        try:
            temp, hum = read_sht41(bus)
            if VERBOSE:
                print(f"âœ… SHT41 ì¸¡ì • ê²°ê³¼: {temp} Â°C, {hum}% RH")
        except Exception as e:
            if VERBOSE:
                print(f"âŒ SHT41 ì˜¤ë¥˜: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í•¨ìˆ˜ ì¸ë²¤í† ë¦¬ (ìš”ì•½ í‘œ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í•¨ìˆ˜ëª…          | ê¸°ëŠ¥ ì„¤ëª…
# --------------- | ----------------------------------------------------------
# select_channel  | PCA9548Aì—ì„œ ì§€ì • ì±„ë„ í™œì„±í™”
# validate_crc    | SHT4x CRC-8 ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
# read_sht41      | SHT41ì—ì„œ ì˜¨ë„/ìŠµë„ ì¸¡ì • í›„ ë°˜í™˜ (CRC ê²€ì¦ í¬í•¨)
#
# ì…ë ¥ê°’(íŒŒë¼ë¯¸í„° íƒ€ì…)
# - select_channel(bus: SMBus, ch: int)
# - validate_crc(data_bytes: list[int], crc_value: int)
# - read_sht41(bus: SMBus)
#
# ë°˜í™˜ê°’
# - select_channel(): None
# - validate_crc(): bool
# - read_sht41(): tuple[float, float]
#
# ì£¼ì˜ì‚¬í•­/ë¡œì§ ìš”ì•½
# - CRC ì˜¤ë¥˜ ë˜ëŠ” ê¸¸ì´ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸ ë°œìƒ
# - PCA9548A ì£¼ì†Œì™€ ì±„ë„ ë²ˆí˜¸ ë°˜ë“œì‹œ í™•ì¸
# - IÂ²C í†µì‹  ì‹¤íŒ¨ ì‹œ OSError ë°œìƒ ê°€ëŠ¥
